# Coturn TURN Server Configuration for IF.swarm (Staging)
#
# Purpose:
# - WebRTC relay server for NAT traversal fallback
# - Secure credential-based authentication
# - IF.witness integrated logging
#
# Philosophy:
# - IF.ground: Reproducible configuration
# - IF.witness: All relay events logged
# - IF.TTT: Transparent relay operations
#
# Generated: Template configuration
# Customize: Set EXTERNAL_IP, authentication credentials, and TLS certificates

# ============================================
# Network Configuration
# ============================================

# Listening port for STUN/TURN (UDP/TCP)
listening-port=3478

# TLS/DTLS listening port
tls-listening-port=5349

# Relay ports range for media forwarding
min-port=49152
max-port=65535

# External IP address (automatically detected if using Docker host network)
# Set explicitly for production:
# external-ip=YOUR_PUBLIC_IP

# Relay IP address (use server's IP)
# relay-ip=YOUR_SERVER_IP

# Listening IP (0.0.0.0 for all interfaces)
listening-ip=0.0.0.0

# ============================================
# Authentication
# ============================================

# Realm for authentication (should match WebRTC client configuration)
realm=ifswarm.staging

# Use long-term credential mechanism
lt-cred-mech

# Static user credentials (username:password format)
# Generate secure credentials using: openssl rand -base64 32
# Example:
# user=ifswarm_user:YOUR_SECURE_PASSWORD_HERE

# Alternatively, use static auth secret for time-limited credentials
# (Recommended for production)
# use-auth-secret
# static-auth-secret=YOUR_SECRET_KEY_HERE

# Note: For staging, add actual credentials here or via environment variables
# For production, use dynamic credential generation via REST API

# ============================================
# Security Configuration
# ============================================

# Enable fingerprint in TURN messages
fingerprint

# Disable older, insecure TLS versions
no-tlsv1
no-tlsv1_1

# Use TLS 1.2 and above
# no-tlsv1_2  # Commented out to allow TLS 1.2

# Disable weak ciphers
cipher-list="ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256"

# Enable DTLS for WebRTC
# no-dtls  # Commented out to allow DTLS

# Certificate files for TLS/DTLS (required for production)
# For staging, you can use self-signed certificates or Let's Encrypt
# Generate self-signed: openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
# cert=/etc/coturn/certs/cert.pem
# pkey=/etc/coturn/certs/key.pem

# Require authentication for TURN
# no-auth  # Commented out - authentication required

# ============================================
# Logging Configuration
# ============================================

# Verbose logging for staging (disable in production for performance)
verbose

# Log file location
log-file=/var/log/coturn/turn.log

# Do not use stdout (logs go to file)
no-stdout-log

# Disable CLI (remote management interface)
no-cli

# Log level: 0 (errors only) to 5 (verbose debug)
# For staging: use 3-4, for production: use 1-2
# Uncomment to set:
# log-level=3

# ============================================
# Performance & Limits
# ============================================

# Maximum allocate lifetime (in seconds)
max-allocate-lifetime=3600

# Maximum bytes per second per session
# 0 = unlimited, set limit for production
max-bps=1000000

# Total server capacity (0 = unlimited)
bps-capacity=0

# Maximum number of relay endpoints per IP
user-quota=100
total-quota=1000

# ============================================
# Network Restrictions
# ============================================

# Disallow peers on the same subnet (security)
no-multicast-peers

# Deny access from private IP ranges (security)
# Uncomment for production:
# denied-peer-ip=10.0.0.0-10.255.255.255
# denied-peer-ip=172.16.0.0-172.31.255.255
# denied-peer-ip=192.168.0.0-192.168.255.255

# Allow access from specific IP ranges (whitelist)
# Uncomment and customize:
# allowed-peer-ip=YOUR_ALLOWED_CIDR_HERE

# ============================================
# Additional Features
# ============================================

# Use fingerprints in the TURN messages
fingerprint

# Enable Mobility support (experimental)
# mobility

# Enable bandwidth efficiency with message padding
# padding

# Server software name (shown in responses)
server-name="IF.swarm TURN Server"

# Allocate threads for better performance
# proc-num=4

# Enable TURN REST API (for dynamic credential generation)
# rest-api-separator=:

# ============================================
# IF.witness Integration
# ============================================

# Log to syslog for centralized logging
# syslog

# Alternatively, use external logging service via syslog
# syslog-facility=local0

# For IF.witness integration, parse logs with:
# - Timestamp extraction
# - Session ID tracking
# - Bandwidth metrics
# - Connection success/failure rates

# Example syslog forwarding to IF.witness:
# syslog-server=witness.ifswarm.staging:514

# ============================================
# Realm-specific Configuration
# ============================================

# Additional realms (if needed for multi-tenant setup)
# realm=ifswarm.production
# realm=ifswarm.development

# ============================================
# Database Configuration (Optional)
# ============================================

# Use database for user management (PostgreSQL, MySQL, MongoDB, Redis)
# For production scale, consider using database-backed user management:
# psql-userdb="host=postgres dbname=turndb user=turn password=turnpass connect_timeout=30"
# mysql-userdb="host=mysql dbname=turndb user=turn password=turnpass connect_timeout=30"
# redis-userdb="ip=redis dbname=0 password=redis_pass connect_timeout=30"

# ============================================
# Notes for Production
# ============================================

# 1. Generate strong credentials:
#    user=ifswarm_prod:$(openssl rand -base64 32)
#
# 2. Configure TLS certificates (Let's Encrypt recommended):
#    cert=/etc/letsencrypt/live/turn.yourdomain.com/fullchain.pem
#    pkey=/etc/letsencrypt/live/turn.yourdomain.com/privkey.pem
#
# 3. Set external-ip to your server's public IP
#
# 4. Enable firewall rules:
#    - Allow UDP/TCP 3478 (STUN/TURN)
#    - Allow TCP 5349 (TLS)
#    - Allow UDP 49152-65535 (relay ports)
#
# 5. Monitor logs and integrate with IF.witness:
#    tail -f /var/log/coturn/turn.log
#
# 6. Test TURN connectivity:
#    https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
